<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>DeepSeek Chat</title>
	{% load static %}
	<script src="{% static 'mainsite/tailwindcss.css' %}"></script>
	<!-- <script src="{% static 'mainsite/highlight.css' %}"></script> -->
	<link rel="stylesheet" href="{% static 'mainsite/highlight.css' %}">
	<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css"> -->
	<script src="{% static 'mainsite/axios_min.js' %}"></script>
	<script src="{% static 'mainsite/highlight.js' %}"></script>
	<script src="{% static 'mainsite/marked.min.js' %}"></script>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script> -->
	<script defer src="{% static 'mainsite/alpinejs_min.js' %}"></script>
	<style>
		/*pre {
			background-color: #2d2d2d;
			padding: 1rem;
			border-radius: 4px;
			overflow-x: auto;
		}*/
		code {
			font-family: 'Courier New', Courier, monospace;
		}
	</style>
</head>
<body class="bg-gray-100">
	<div x-data="app()" class="min-h-screen">
		<!-- 登录模块 -->
		<div x-show="!username" class="max-w-md mx-auto mt-20 p-6 bg-white rounded-lg shadow">
			<h2 class="text-2xl font-bold mb-4">用户登录</h2>
			<form @submit.prevent="login">
				{% csrf_token %}
				<input x-model="loginForm.username"
					   type="text"
					   placeholder="用户名"
					   class="w-full mb-3 p-2 border rounded" name="username">
				<input x-model="loginForm.password"
					   type="password"
					   placeholder="密码"
					   class="w-full mb-3 p-2 border rounded" name="password">
				<button type="submit"
						class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
					登录
				</button>
			</form>
			<div class="mt-4 text-center">
				<a href="{% url 'mainsite:register' %}" class="text-blue-500 hover:text-blue-700">注册</a>
			</div>
		</div>

		<!-- 主界面 -->
		<div x-show="username" class="flex h-screen">
			<!-- 侧边栏 - 历史记录 -->
			<div class="w-64 bg-white border-r flex flex-col">
				<div class="p-4">
					<h3 class="text-lg font-semibold mb-4">历史对话</h3>
					<!-- 新增的生成新对话按钮 -->
					<button @click="createNewChat"
							class="w-full mt-4 p-2 bg-green-500 text-white rounded hover:bg-green-600">
						新建对话
					</button>
				</div>
				<!-- 历史对话列表，单独设置滚动 -->
				<div class="flex-1 overflow-y-auto overflow-x-hidden p-4">
					<div class="space-y-2">
						<template x-for="item in titles.slice().reverse()" :key="item.id">
							<div @click="loadMessages(item.id)"
								 class="p-2 hover:bg-gray-100 cursor-pointer rounded"
								 :class="{ 'bg-blue-50': item.id === cid }">
								<div class="text-sm" x-text="item.title"></div>
								<div class="text-xs text-gray-500" x-text="item.date"></div>
							</div>
						</template>
						
					</div>
				</div>
			</div>

			<!-- 主聊天区域 -->
			<div class="flex-1 flex flex-col">
				<!-- 顶部横条 -->
				<div class="p-4 bg-gray-100 border-b">
					<div class="flex justify-between items-center mb-4">
						<div x-show = "!isEditingTitle" class="text-lg font-semibold" x-text="topBarContent"></div>
						<!-- 修改标题按钮 -->
						<button x-show="cid !== -1 && !isEditingTitle" @click="enableEditTitle" class="p-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
							修改标题
						</button>
					</div>
					<div x-show="isEditingTitle" class="p-4 bg-gray-50 border-b">
						<div class="flex space-x-2">
							<input x-model="newTitle"
								   type="text"
								   placeholder="输入新标题"
								   class="flex-1 p-2 border rounded">
							<button @click="saveTitle" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
								保存
							</button>
							<button @click="cancelEditTitle" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
								取消
							</button>
						</div>
					</div>
				</div>
				<!-- 消息区域 -->
				<div class="flex-1 overflow-y-auto p-4 space-y-4">
					<template x-for="message in messages" :key="message.id">
						<div :class="message.role === 'user' ? 'text-right' : 'text-left'">
							<div class="inline-block p-3 rounded-lg max-w-[70%]"
								 :class="message.role === 'user'
									 ? 'bg-blue-500 text-white'
									 : 'bg-gray-200 text-gray-800'">
								<!-- <div x-text="message.content"></div> -->
								<div x-html="marked.parse(message.content)"></div>
								<div class="text-xs mt-1 opacity-70"
									 x-text="message.timestamp"></div>
							</div>
						</div>
					</template>
				</div>

				<!-- 输入区域 -->
				<div class="p-4 border-t bg-white">
					<form @submit.prevent="sendMessage">
						<div class="flex space-x-2">
							<textarea x-model="inputMessage"
								   type="text"
								   placeholder="输入消息..."
								   class="flex-1 p-2 border rounded"></textarea>
							<button type="submit"
									class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
								发送
							</button>
						</div>
					</form>
					<!-- 语言模型选择框 -->
					<div class="mt-2">
						<select id="model-select" x-model="selectedModel" :disabled="cid !== -1" class="mt-1 block w-full p-2 border rounded">
							<template x-for="item in models">
								<option :value="item" x-text="item"></option>
							</template>
						</select>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>

	</script>
	<script defer>

		function deleteCookie(name, path, domain) {
			document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT;' +
				(path ? '; path=' + path : '') +
				(domain ? '; domain=' + domain : '');
		}
		function app() {
			return {
				// 应用状态
				user: null,
				loginForm: {
					csrfmiddlewaretoken: "",
					username: '',
					password: '',
				},
				messages: [],
				titles: [],
				models: [],
				inputMessage: '',
				username: null,
				topBarContent: null,
				cid: -1,
				isEditingTitle: false,
				newTitle: null,
				selectedModel: null,
				in_talk: false,
				marked,

				init() {
					marked.setOptions({
						break: true,
						renderer: new marked.Renderer(),
						highlight: function (code, language) {
							console.log(123)
							// 检查语言是否有效，如果无效则使用 'plaintext'
							const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
							try {
								// 使用 highlight.js 高亮代码
								return hljs.highlight(code, { language: validLanguage }).value;
							} catch (error) {
								// 如果高亮失败，返回原始代码
								console.error('Error highlighting code:', error);
								return code;
							}
						}
					});
					console.log(marked.parse("ewfjio\n\n```\nsojgi\n```"));
					console.log("init");
					this.topBarContent = "新对话";
					for (let i = 0; i < this.titles.length; ++i){
						this.titles[i].date = new Date(this.titles[i].date).toLocaleString();
					}
					if (document.cookie) {
						const cookiePairs = document.cookie.split('; ');
						cookiePairs.forEach(pair => {
							const [key, value] = pair.split('=');
							if (key=="username"){
								this.username = decodeURIComponent(value);
							}
						});
					}
					if (this.username){
						this.loadHistory();
						this.loadModels();
					}
				},

				// 登录方法
				login() {
					this.loginForm.csrfmiddlewaretoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
					axios.post(
							"{% url 'mainsite:login' %}",
							new URLSearchParams(this.loginForm).toString(),
						)
						.then(response => {
							console.log(response)
							window.location.href = "{% url 'mainsite:site' %}";
						})
						.catch(error => {
							console.error('登录失败:', error);
						});
				},
				logout() {
					deleteCookie("username");
					window.location.href = "{% url 'mainsite:site' %}";
				},

				// 发送消息
				sendMessage() {
					if (!this.inputMessage.trim()) return;
					if (this.in_talk) return ;
					this.cancelEditTitle();
					const uploadMessage = this.inputMessage;
					this.inputMessage = null;

					this.messages.push({
						id: Date.now(),
						content: uploadMessage,
						role: 'user',
						timestamp: new Date().toLocaleTimeString()
					});

					fetch("{% url 'mainsite:talk' %}", {
						method: 'POST',	
					
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						},
						body: JSON.stringify({
							model_name: this.selectedModel,
							message: uploadMessage,
							timestamp: Date.now(),
							cid: this.cid,
						})
					})
					.then(response => {
						this.in_talk = true;
						console.log(response)
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						this.messages.push({
							id: Date.now(),
							content: "",
							role: 'assistant',
							timestamp: new Date().toLocaleTimeString(),
						});
						const reader = response.body.getReader();
						const decoder = new TextDecoder();

						var firstchunk = true;
						const readChunk = () => {
							reader.read().then(({ done, value }) => {
								if (done) {
									console.log('Stream complete');
									
									this.in_talk = false;
									return;
								}
		
								const chunk = decoder.decode(value);
								// 假设服务器返回的是逐行 JSON 数据
								chunk.split('\n').forEach(line => {
									if (line.trim()) {

									try {
										const jsonData = JSON.parse(line);
										if (firstchunk){
											if (this.cid == -1){ // 新对话
												this.titles.push({
													id: jsonData.cid,
													title: jsonData.title,
													date: Date.now(),
												});
												this.cid = jsonData.cid;
												this.update_topBar();
											}
											firstchunk = false;
										}
										this.messages[this.messages.length-1].content += jsonData.message;
									} catch (error) {
										console.error('Error parsing JSON:', error);
									}

									}
								});
								readChunk();  // 继续读取下一个数据块
							});
						};
						readChunk();
					})
					.catch(error => {
						console.error('Error fetching stream:', error);
					});
				},

				loadModels() {
					axios.get("{% url 'mainsite:other_functions' %}", {
						params:{
							cmd: "load models",
						}
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						this.models = response.data.data;
						this.selectedModel = this.models[0];
					})
					.catch(error => {
						console.error('loadModels请求失败:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},
				// 加载历史记录
				loadHistory() {
					console.log("loadHis");
					axios.get("{% url 'mainsite:talk' %}", {
						params:{
							cid: -1,
						}
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						this.titles = response.data.titles
						for (var i = 0; i < this.titles.length; i++) {
							this.titles[i].date = new Date(this.titles[i].date).toLocaleString();
							this.titles[i].title = this.titles[i].title;
						}
					})
					.catch(error => {
						console.error('loadHistory请求失败:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},

				// 加载对话消息
				loadMessages(cid){
					if (this.in_talk) return ;
					console.log("cid",cid);
					axios.get("{% url 'mainsite:talk' %}", {
						params:{
							cid: cid,
						}
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						this.messages = response.data.messages
						for (var i = 0; i < this.messages.length; i++) {
							this.messages[i].timestamp =new Date(this.messages[i].timestamp).toLocaleString();
						}
						this.cid = cid;
						this.update_topBar();
						// hljs.highlightAll();
					})
					.catch(error => {
						console.error('loadMessages请求失败:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},

				// 更新当前对话标题
				update_topBar() {
					for (let i = 0; i < this.titles.length; i++) {
						if (this.cid == this.titles[i].id){
							this.topBarContent = this.titles[i].title;
							break;
						}
					}
				},

				// 开启新对话
				createNewChat() {
					if (this.in_talk) return ;
					this.cid = -1;
					this.topBarContent = "新对话";
					this.messages = [];
				},
				// 开启/关闭标题编辑
				enableEditTitle(){
					if (this.in_talk) return ;
					this.isEditingTitle = true;
					this.newTitle = this.topBarContent;
				},
				cancelEditTitle(){
					if (this.in_talk) return ;
					this.isEditingTitle = false;
					this.newTitle = null;
				},

				// 保存新标题
				saveTitle(){
					if (this.in_talk) return ;
					console.log("saveTitle",this.newTitle);
					axios.post("{% url 'mainsite:other_functions' %}", {
						cmd: "change communication title",
						cid: this.cid,
						newtitle: this.newTitle,
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						for (let i = 0; i < this.titles.length; i++) {
							if (this.cid == this.titles[i].id){
								this.titles[i].title = this.newTitle;
								this.topBarContent = this.titles[i].title;
								break;
							}
						}
						this.cancelEditTitle();
					})
					.catch(error => {
						console.error('saveTitle请求失败:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},
			}
		}
		
	</script>
</body>
</html>