<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>DeepSeek Chat</title>
	{% load static %}
	<link rel="stylesheet" href="{% static 'mainsite/highlight.css' %}">
	<link href="{% static 'mainsite/mainsite.css' %}" rel="stylesheet">
	<link href="{% static 'mainsite/mainsite_ex.css' %}" rel="stylesheet">
	<link href="{% static 'mainsite/bg-color.css' %}" rel="stylesheet">
	<link href="{% static 'mainsite/hover-color.css' %}" rel="stylesheet">
	<link rel="icon" type="image/x-icon" href="{% static 'mainsite/favicon.ico' %}">
	<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"> -->

</head>
<body class="body">
	{% csrf_token %}
	<!-- ä¸»ç•Œé¢ -->
	<div x-data="app()" class="maindiv">

		<!-- ä¾§è¾¹æ  - å†å²è®°å½• -->
		<div x-show="!sidebar_hidden" class="sidebar">
			
			<div class="sidebar_top">
				<div class="sidebar_top_1">
					<h3 class="site_title">{{ website_name }}</h3>
					<img class="hide_sidebar_btn" @click="hide_sidebar" src="{% static 'mainsite/hidesidebar.png' %}"></img>
				</div>
				<!-- æ–°å¢çš„ç”Ÿæˆæ–°å¯¹è¯æŒ‰é’® -->
				<button @click="createNewChat" class="new_communication" @keydown.window.k=UserPressK(event)>
					æ–°å»ºå¯¹è¯
				</button>
			</div>
			<!-- å†å²å¯¹è¯åˆ—è¡¨ï¼Œå•ç‹¬è®¾ç½®æ»šåŠ¨ -->
			<div class="history_list" id="history_list">
				<template x-for="(diff_item,index) in title_diff_days">
					<div x-show="titles[index].length !== 0">
						<div x-text="diff_item.name" class="time_diff"></div>
						<template x-for="item in titles[index]">
							<div @click="get_communication_content(item.id)"
								class="history_list_item"
								:class="{ 'history_list_item_focus': item.id === cid }"
								x-data = "{private_show_btn : false}"
								@mouseenter="private_show_btn = true"
								@mouseleave="private_show_btn = false">
								<div>
									<div class="history_item_title" x-text="item.title"></div>
								</div>

								<button x-show = "private_show_btn" @click.stop="deleteCommunication(item.id,item.title)" class="delete_communication_btn">âŒ</button>
								
							</div>
						</template>
					</div>
				</template>
			</div>
			<!-- ä¸ªäººä¿¡æ¯ -->
			<div 
				x-ref="personal_info"
				@click="personal_info_toggleButtons"
				class="personal_info"
			>
				<div class="personal_info_text">ä¸ªäººä¿¡æ¯</div>
				
				<!-- æŒ‰é’®ç»„ -->
				<div x-show="personal_info_showButtons" style="display: none;" class="personal_info_btns">
					<button class="personal_info_btn bg-green-500 hover:bg-green-600" @click="logout">ç™»å‡º</button>
					
					<button class="personal_info_btn bg-red-500 hover:bg-red-600" @click="window.location.href = '{% url 'mainsite:change_password' %}'">ä¿®æ”¹å¯†ç </button>
					
					<button class="personal_info_btn bg-purple-500 hover:bg-purple-600" @click="window.location.href = '{% url 'mainsite:site_mailbox' %}'">è”ç³»æˆ‘ä»¬</button>
				</div>
			</div>
		</div>

		<!-- éšè—åçš„ä¾§è¾¹æ  -->
		<div x-show="sidebar_hidden" style="display: none;" class="hidden_sidebar">
			<img class="show_sidebar_btn" @click="show_sidebar" src="{% static 'mainsite/showsidebar.png' %}"></img>
		</div>

		<!-- ä¸»èŠå¤©åŒºåŸŸ -->
		<div class="main_communication_area">
			<!-- é¡¶éƒ¨æ¨ªæ¡ -->
	
			<!-- å·¦ä¾§ï¼šè¯­è¨€æ¨¡å‹é€‰æ‹©æ¡†å’Œæ ‡é¢˜/è¾“å…¥æ¡† -->
			<div class="topbar">
				<!-- è¯­è¨€æ¨¡å‹é€‰æ‹©æ¡† -->
				<div>
					<select id="model-select" x-model="selectedModelid" :disabled="in_talk" class="model_select" @change="UserChangeModel(event)">
						<template x-for="(item,index) in models">
							<option :value="`${index}`" x-text="item.name"></option>
						</template>
					</select>
				</div>
				<!-- æ ‡é¢˜å’Œè¾“å…¥æ¡† -->
				<div class="communication_title_and_change">
					<!-- æ ‡é¢˜ -->
					<div x-show="!isEditingTitle" class="communication_title" x-text="topBarContent"></div>
					<!-- ä¿®æ”¹æ ‡é¢˜æŒ‰é’® -->
					<button x-show="cid !== -1 && !isEditingTitle" @click="enableEditTitle" class="change_title_btn">
						ğŸ“
					</button>
					<!-- è¾“å…¥æ¡† -->
					<div style="display: none;" x-show="isEditingTitle" class="new_title_input_and_button">
						<input x-model="topBarContent"
								type="text"
								placeholder="è¾“å…¥æ–°æ ‡é¢˜"
								class="new_title_input"
								id="newTitleInput"
								@keydown.enter="userPressEnterInEditingTitle(event)"
								@blur="saveTitle"
								@keydown.escape="saveTitle">
					</div>
				</div>
			</div>

			<!-- æ¶ˆæ¯åŒºåŸŸ -->
			<div class="communication_area" id="message_area" :class="{ 'hidden': cid === -1 }">
				<div class="communication_area_contract">
					<template x-for="message in messages">
						<div :class="message.role === 'user' ? 'text-right' : 'text-left'"
							 x-data = "{ifenter : false}" 
							 @mouseenter="ifenter = true" 
							 @mouseleave="ifenter = false">
							<div class="message">
								<template x-if="message.role === 'user'">
									<div class="message_user_block">
										<div style="display: none;" x-text="message.content"></div>
										<img class="message_user_copy" src="{% static 'mainsite/copybtn.png' %}" x-show="ifenter" @click="UserCopyMessage(event)"></img>
										<!-- ç”¨æˆ·æ¶ˆæ¯æ ·å¼ -->
										<div class="message_user" x-text="message.content"></div>
									</div>
								</template>
								<template x-if="message.role === 'assistant'">
									
									<div class="message_assistant_and_icon">
										
										<template x-if="message.model === 'deepseek'"><img src="{% static 'mainsite/ds_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'doubao'"><img src="{% static 'mainsite/db_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'openai'"><img src="{% static 'mainsite/default_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'none'"><img src="{% static 'mainsite/default_dialog.png' %}" class="assistant_icon"></template>

										<!-- Deepseek åŠ©æ‰‹æ¶ˆæ¯æ ·å¼ -->
										<div>
											<div class="message_assistant" x-html="marked.parse(message.content)"></div>
											<div class="assistant_user_copy_div">
												<div style="display: none;" x-text="message.content"></div>
												<img class="assistant_user_copy" src="{% static 'mainsite/copybtn.png' %}" x-show="ifenter" @click="UserCopyMessage(event)"></img>
											</div>
											
										</div>
									</div>
									
								</template>
								<template x-if="message.role === 'reasoning'">

									<!-- æ·±åº¦æ€è€ƒå†…å®¹æ ·å¼ -->
									<div class="message_reasoning" x-html="marked.parse(message.content)"></div>
								</template>

								<!-- ç­‰å¾…æœåŠ¡å™¨è¿”å›æ¶ˆæ¯ï¼Œè½¬åœˆåœˆ -->
								<template x-if="message.role === 'waiting'">
									<div>
										<template x-if="message.model === 'deepseek'"><img src="{% static 'mainsite/ds_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'doubao'"><img src="{% static 'mainsite/db_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'openai'"><img src="{% static 'mainsite/default_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'none'"><img src="{% static 'mainsite/default_dialog.png' %}" class="assistant_icon"></template>
										<img src="{% static 'mainsite/circle-loading.gif' %}" class="chat_loading_gif">
									</div>
								</template>
							</div>
							
						</div>
					</template>
				</div>
			</div>

			<!-- è¾“å…¥åŒºåŸŸ -->
			<div class="user_input_area">
				<div x-show = "cid === -1" class="input_service_description">
					<div class="input_service_description_line1">
						<img src="{% static 'mainsite/101.png' %}" class="input_service_description_icon">
						<div class="input_service_description_text">æˆ‘æ˜¯ {{ website_name }} ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼</div>
					</div>
					
				</div>
				<form @submit.prevent="sendMessage">
					<div class="user_input_form">
						<div>
							<textarea x-model="inputMessage"
								 type="text"
								 placeholder='è¾“å…¥æ¶ˆæ¯...(æŒ‰"/"å¿«é€Ÿè¾“å…¥ æŒ‰enterå‘é€)'
								 class="user_input_textarea"
								 id="user_input_textarea"
								 @keydown.enter="userPressEnterInSendMessage(event)"
								 @keydown.window.slash=focusOnInput(event)></textarea>
						</div>
						<div>
							<img src="{% static 'mainsite/settings.png' %}" class="settings_btn" @click="UserEnterSettings(event)">

						</div>
						<!-- <button type="submit" class="user_input_submit_btn">å‘é€</button> -->
					</div>
				</form>
				
			</div>
		</div>
		<div style="display: none;" x-show="show_settings" class="settings_background" @keydown.window.escape="CloseSettings()">
			<div class="settings_div" @click.away="CloseSettings()">
				<div>
					<img src="{% static 'mainsite/close.png' %}" class="settings_close_img" @click="CloseSettings()">
				</div>
				<div>
					<div style="margin-bottom: 10px;">ç³»ç»Ÿæç¤ºè¯ï¼š</div>
					<textarea class="system_content_textarea" x-model="system_content"></textarea>
				</div>
			</div>
		</div>
	</div>
	<!-- <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script> -->
	<script defer src="{% static 'mainsite/alpinejs_min.js' %}"></script>
	<script src="{% static 'mainsite/highlight.js' %}"></script>
	<script src="{% static 'mainsite/axios_min.js' %}"></script>
	<script src="{% static 'mainsite/my_marked.js' %}"></script>
	<script>
		urls = {}
		urls["login"] = "{% url 'mainsite:login' %}";
		urls["logout"] = "{% url 'mainsite:logout' %}";
		urls["talk"] = "{% url 'mainsite:talk' %}";
		urls["get_available_models"] = "{% url 'mainsite:get_available_models' %}";
		urls["get_history"] = "{% url 'mainsite:get_history' %}";
		urls["get_communication_content"] = "{% url 'mainsite:get_communication_content' %}";
		urls["delete_communication"] = "{% url 'mainsite:delete_communication' %}";
		urls["change_communication_title"] = "{% url 'mainsite:change_communication_title' %}";
		urls["copybtn_png"] = "{% static 'mainsite/copybtn.png' %}";
		urls["check_png"] = "{% static 'mainsite/check.png' %}";
		urls["get_system_content"] = "{% url 'mainsite:get_system_content' %}";
	</script>
	<script src="{% static 'mainsite/mainsite.js' %}"> </script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
	<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
</body>
</html>