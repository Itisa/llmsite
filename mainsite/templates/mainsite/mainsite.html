<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>DeepSeek Chat</title>
	{% load static %}
	<link rel="stylesheet" href="{% static 'mainsite/highlight.css' %}">
	<script src="{% static 'mainsite/highlight.js' %}"></script>

	<script src="{% static 'mainsite/axios_min.js' %}"></script>
	<script src="{% static 'mainsite/marked.min.js' %}"></script>
	<link href="{% static 'mainsite/mainsite.css' %}" rel="stylesheet">
	<link href="{% static 'mainsite/mainsite_ex.css' %}" rel="stylesheet">
	<link href="{% static 'mainsite/bg-color.css' %}" rel="stylesheet">
	<link href="{% static 'mainsite/hover-color.css' %}" rel="stylesheet">
	<!-- <link rel="stylesheet" href="{% static 'mainsite/katex.min.css' %}"> -->
	<!-- <script src="{% static 'mainsite/katex.min.js' %}"></script> -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
	<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

	<script defer src="{% static 'mainsite/alpinejs_min.js' %}"></script>

</head>
<body class="body">
	{% csrf_token %}
	<!-- ä¸»ç•Œé¢ -->
	<div x-data="app()" class="maindiv">

		<!-- ä¾§è¾¹æ  - å†å²è®°å½• -->
		<div class="sidebar">
			<div class="sidebar_top">
				<h3 class="site_title">å†å²å¯¹è¯</h3>
				<!-- æ–°å¢çš„ç”Ÿæˆæ–°å¯¹è¯æŒ‰é’® -->
				<button @click="createNewChat" class="new_communication">
					æ–°å»ºå¯¹è¯
				</button>
			</div>
			<!-- å†å²å¯¹è¯åˆ—è¡¨ï¼Œå•ç‹¬è®¾ç½®æ»šåŠ¨ -->
			<div class="history_list">
				<template x-for="item in titles.slice().reverse()" :key="item.id">
					<div @click="get_communication_content(item.id)"
						 class="history_list_item"
						 :class="{ 'history_list_item_focus': item.id === cid }">
						<div>
							<div class="history_item_title" x-text="item.title"></div>
							<div class="history_item_date" x-text="item.date"></div>
						</div>
						<button @click.stop="deleteCommunication(item.id,item.title)" class="delete_communication_btn">
							åˆ é™¤
						</button>
					</div>
					</template>
			</div>
			<!-- ä¸ªäººä¿¡æ¯ -->
			<div 
				x-ref="personal_info"
				@click="personal_info_toggleButtons"
				class="personal_info"
			>
				<div class="personal_info_text">ä¸ªäººä¿¡æ¯</div>
				
				<!-- æŒ‰é’®ç»„ -->
				<div x-show="personal_info_showButtons" class="personal_info_btns">
					<button class="personal_info_btn bg-green-500 hover:bg-green-600" @click="logout">ç™»å‡º</button>
					
					<button class="personal_info_btn bg-red-500 hover:bg-red-600" @click="window.location.href = '{% url 'mainsite:change_password' %}'">ä¿®æ”¹å¯†ç </button>
					
					<button class="personal_info_btn bg-purple-500 hover:bg-purple-600" @click="window.location.href = '{% url 'mainsite:site_mailbox' %}'">è”ç³»æˆ‘ä»¬</button>
				</div>
			</div>
		</div>

		<!-- ä¸»èŠå¤©åŒºåŸŸ -->
		<div class="main_communication_area">
			<!-- é¡¶éƒ¨æ¨ªæ¡ -->

	
			<!-- å·¦ä¾§ï¼šè¯­è¨€æ¨¡å‹é€‰æ‹©æ¡†å’Œæ ‡é¢˜/è¾“å…¥æ¡† -->
			<div class="topbar">
				<!-- è¯­è¨€æ¨¡å‹é€‰æ‹©æ¡† -->
				<div>
					<select id="model-select" x-model="selectedModel" :disabled="in_talk" class="model_select">
						<template x-for="item in models">
							<option :value="item" x-text="item"></option>
						</template>
					</select>
				</div>
				<!-- æ ‡é¢˜å’Œè¾“å…¥æ¡† -->
				<div class="communication_title_and_change">
					<!-- æ ‡é¢˜ -->
					<div x-show="!isEditingTitle" class="communication_title" x-text="topBarContent"></div>
					<!-- ä¿®æ”¹æ ‡é¢˜æŒ‰é’® -->
					<button x-show="cid !== -1 && !isEditingTitle" @click="enableEditTitle" class="change_title_btn">
						ğŸ“
					</button>
					<!-- è¾“å…¥æ¡† -->
					<div x-show="isEditingTitle" class="new_title_input_and_button">
						<input x-model="topBarContent"
								type="text"
								placeholder="è¾“å…¥æ–°æ ‡é¢˜"
								class="new_title_input"
								id="newTitleInput"
								@keydown.enter="userPressEnterInEditingTitle(event)"
								@blur="saveTitle"
								@keydown.escape="saveTitle">
						<!-- <button @click="saveTitle" class="save_title">ä¿å­˜</button> -->
						<!-- <button @click="cancelEditTitle" class="cancel_edit_title">å–æ¶ˆ</button> -->
					</div>
				</div>

				
			</div>

			<!-- æ¶ˆæ¯åŒºåŸŸ -->
			<div class="communication_area" id="message_area">
				<template x-for="message in messages" :key="message.id">
					<div :class="message.role === 'user' ? 'text-right' : 'text-left'">
						<div class="message">
							<template x-if="message.role === 'user'">
								<div>
									<!-- ç”¨æˆ·æ¶ˆæ¯æ ·å¼ -->
									<div class="message_user" x-text="message.content"></div>
									<!-- æ—¶é—´æˆ³ï¼ˆä»… user æ˜¾ç¤ºï¼‰ -->
									<!-- <div class="message_date_user" x-text="message.timestamp"></div> -->
								</div>
							</template>
							<template x-if="message.role === 'assistant'">
								<div>
									<!-- <div><img src="{% static 'mainsite/ds.png' %}" class="assistant_icon"></div> -->
									<!-- Deepseek åŠ©æ‰‹æ¶ˆæ¯æ ·å¼ -->
									<div class="message_assistant" x-html="marked.parse(message.content)"></div>
									<!-- æ—¶é—´æˆ³ï¼ˆä»… assistant æ˜¾ç¤ºï¼‰ -->
									<!-- <div class="message_date_assistant" x-text="message.timestamp"></div> -->
								</div>
							</template>
							<template x-if="message.role === 'reasoning'">

								<!-- æ·±åº¦æ€è€ƒå†…å®¹æ ·å¼ -->
								<div class="message_reasoning" x-html="marked.parse(message.content)"></div>
								<!-- reasoning ä¸æ˜¾ç¤ºæ—¶é—´æˆ³ -->
							</template>
						</div>
					</div>
				</template>
			</div>

			<!-- è¾“å…¥åŒºåŸŸ -->
			<div class="user_input_area">
				<form @submit.prevent="sendMessage">
					<div class="user_input_form">
						<textarea x-model="inputMessage"
								 type="text"
								 placeholder='è¾“å…¥æ¶ˆæ¯...(æŒ‰"/"å¿«é€Ÿè¾“å…¥)'
								 class="user_input_textarea"
								 id="user_input_textarea"
								 @keydown.enter="userPressEnterInSendMessage(event)"
								 @keydown.window.slash=focusOnInput(event)></textarea>
						<button type="submit"
								class="user_input_submit_btn">
							å‘é€
						</button>
					</div>
				</form>
				
			</div>
		</div>

	</div>
	<script>
		urls = {}
		urls["login"] = "{% url 'mainsite:login' %}";
		urls["logout"] = "{% url 'mainsite:logout' %}";
		urls["talk"] = "{% url 'mainsite:talk' %}";
		urls["get_available_models"] = "{% url 'mainsite:get_available_models' %}";
		urls["get_history"] = "{% url 'mainsite:get_history' %}";
		urls["get_communication_content"] = "{% url 'mainsite:get_communication_content' %}";
		urls["delete_communication"] = "{% url 'mainsite:delete_communication' %}";
		urls["change_communication_title"] = "{% url 'mainsite:change_communication_title' %}";
	</script>
	<script src="{% static 'mainsite/mainsite.js' %}"> </script>
</body>
</html>