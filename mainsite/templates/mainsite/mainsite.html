<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>{{ website_name }}</title>
	{% load static %}
	<link rel="stylesheet" href="{% static 'css/highlight.css' %}">
	<link href="{% static 'css/mainsite.css' %}" rel="stylesheet">
	<link href="{% static 'css/mainsite_ex.css' %}" rel="stylesheet">
	<link href="{% static 'css/bg-color.css' %}" rel="stylesheet">
	<link href="{% static 'css/hover-color.css' %}" rel="stylesheet">
	<link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
	<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"> -->

</head>
<body class="body">
	{% csrf_token %}
	<!-- ä¸»ç•Œé¢ -->
	<div x-data="app()" class="maindiv">

		<!-- ä¾§è¾¹æ  - å†å²è®°å½• -->
		<div x-show="!sidebar_hidden" class="sidebar">
			
			<div class="sidebar_top">
				<div class="sidebar_top_1">
					<h3 class="site_title">{{ website_name }}</h3>
					<img class="hide_sidebar_btn" @click="hide_sidebar" src="{% static 'images/hidesidebar.png' %}"></img>
				</div>
				<!-- æ–°å¢çš„ç”Ÿæˆæ–°å¯¹è¯æŒ‰é’® -->
				<button @click="createNewChat" class="new_communication" @keydown.window.k=UserPressK(event)>
					æ–°å»ºå¯¹è¯
				</button>
			</div>
			<!-- å†å²å¯¹è¯åˆ—è¡¨ï¼Œå•ç‹¬è®¾ç½®æ»šåŠ¨ -->
			<div class="history_list" id="history_list">
				<template x-for="(diff_item,index) in title_diff_days">
					<div x-show="titles[index].length !== 0">
						<div x-text="diff_item.name" class="time_diff"></div>
						<template x-for="item in titles[index]">
							<div @click="get_communication_content(item.id)"
								class="history_list_item"
								:class="{ 'history_list_item_focus': item.id === cid }"
								x-data = "{private_show_btn : false}"
								@mouseenter="private_show_btn = true"
								@mouseleave="private_show_btn = false">
								<div>
									<div class="history_item_title" x-text="item.title"></div>
								</div>

								<button x-show = "private_show_btn" @click.stop="deleteCommunication(item.id,item.title)" class="delete_communication_btn">âŒ</button>
								
							</div>
						</template>
					</div>
				</template>
			</div>
			<!-- ä¸ªäººä¿¡æ¯ -->
			<div 
				x-ref="personal_info"
				@click="personal_info_toggleButtons"
				class="personal_info"
			>
				<div class="personal_info_text">ä¸ªäººä¿¡æ¯</div>
				
				<!-- æŒ‰é’®ç»„ -->
				<div x-show="personal_info_showButtons" style="display: none;" class="personal_info_btns">
					<button class="personal_info_btn bg-green-500 hover:bg-green-600" @click="logout">ç™»å‡º</button>
					
					<button class="personal_info_btn bg-red-500 hover:bg-red-600" @click="window.location.href = '{% url 'mainsite:change_password' %}'">ä¿®æ”¹å¯†ç </button>
					
					<button class="personal_info_btn bg-purple-500 hover:bg-purple-600" @click="window.location.href = '{% url 'mainsite:site_mailbox' %}'">è”ç³»æˆ‘ä»¬</button>
				</div>
			</div>
		</div>

		<!-- éšè—åçš„ä¾§è¾¹æ  -->
		<div x-show="sidebar_hidden" style="display: none;" class="hidden_sidebar">
			<img class="show_sidebar_btn" @click="show_sidebar" src="{% static 'images/showsidebar.png' %}"></img>
		</div>

		<!-- ä¸»èŠå¤©åŒºåŸŸ -->
		<div class="main_communication_area">
			<!-- é¡¶éƒ¨æ¨ªæ¡ -->
	
			<!-- å·¦ä¾§ï¼šè¯­è¨€æ¨¡å‹é€‰æ‹©æ¡†å’Œæ ‡é¢˜/è¾“å…¥æ¡† -->
			<div class="topbar">
				<!-- è¯­è¨€æ¨¡å‹é€‰æ‹©æ¡† -->
				<div>
					<select id="model-select" x-model="selectedModelid" :disabled="in_talk" class="model_select" @change="UserChangeModel(event)">
						<template x-for="(item,index) in models">
							<option :value="`${index}`" x-text="item.name"></option>
						</template>
					</select>
				</div>
				<!-- æ ‡é¢˜å’Œè¾“å…¥æ¡† -->
				<div class="communication_title_and_change">
					<!-- æ ‡é¢˜ -->
					<div x-show="!isEditingTitle" class="communication_title" x-text="topBarContent"></div>
					<!-- ä¿®æ”¹æ ‡é¢˜æŒ‰é’® -->
					<button x-show="cid !== -1 && !isEditingTitle" @click="enableEditTitle" class="change_title_btn">
						ğŸ“
					</button>
					<!-- è¾“å…¥æ¡† -->
					<div style="display: none;" x-show="isEditingTitle" class="new_title_input_and_button">
						<input x-model="topBarContent"
								type="text"
								placeholder="è¾“å…¥æ–°æ ‡é¢˜"
								class="new_title_input"
								id="newTitleInput"
								@keydown.enter="userPressEnterInEditingTitle(event)"
								@blur="saveTitle"
								@keydown.escape="saveTitle">
					</div>
				</div>
			</div>

			<!-- æ¶ˆæ¯åŒºåŸŸ -->
			<div class="communication_area" id="message_area" :class="{ 'hidden': cid === -1 }">
				<div class="communication_area_contract">
					<template x-for="message in messages">
						<div :class="message.role === 'user' ? 'text-right' : 'text-left'"
							 x-data = "{ifenter : false}" 
							 @mouseenter="ifenter = true" 
							 @mouseleave="ifenter = false">
							<div class="message">
								<template x-if="message.role === 'user'">
									<div class="message_user_block">
										<div style="display: none;" x-text="message.content"></div>
										<img class="message_user_copy" src="{% static 'images/copybtn.png' %}" x-show="ifenter" @click="UserCopyMessage(event)"></img>
										<!-- ç”¨æˆ·æ¶ˆæ¯æ ·å¼ -->
										<div class="message_user" x-text="message.content"></div>
									</div>
								</template>
								<template x-if="message.role === 'assistant'">
									
									<div class="message_assistant_and_icon">
										
										<template x-if="message.model === 'deepseek'"><img src="{% static 'images/ds_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'doubao'"><img src="{% static 'images/db_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'openai'"><img src="{% static 'images/oa_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'none'"><img src="{% static 'images/default_dialog.png' %}" class="assistant_icon"></template>

										<!-- Deepseek åŠ©æ‰‹æ¶ˆæ¯æ ·å¼ -->
										<div>
											<div class="message_assistant" x-html="marked.parse(message.content)"></div>
											<div class="assistant_user_copy_div">
												<div style="display: none;" x-text="message.content"></div>
												<img class="assistant_user_copy" src="{% static 'images/copybtn.png' %}" x-show="ifenter" @click="UserCopyMessage(event)"></img>
											</div>
											
										</div>
									</div>
									
								</template>
								<template x-if="message.role === 'reasoning'">

									<!-- æ·±åº¦æ€è€ƒå†…å®¹æ ·å¼ -->
									<div class="message_reasoning" x-html="marked.parse(message.content)"></div>
								</template>

								<!-- ç­‰å¾…æœåŠ¡å™¨è¿”å›æ¶ˆæ¯ï¼Œè½¬åœˆåœˆ -->
								<template x-if="message.role === 'waiting'">
									<div>
										<template x-if="message.model === 'deepseek'"><img src="{% static 'images/ds_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'doubao'"><img src="{% static 'images/db_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'openai'"><img src="{% static 'images/default_dialog.png' %}" class="assistant_icon"></template>
										<template x-if="message.model === 'none'"><img src="{% static 'images/default_dialog.png' %}" class="assistant_icon"></template>
										<img src="{% static 'images/circle-loading.gif' %}" class="chat_loading_gif">
									</div>
								</template>
							</div>
							
						</div>
					</template>
				</div>
			</div>

			<!-- è¾“å…¥åŒºåŸŸ -->
			<div class="user_input_area">
				<div x-show = "cid === -1" class="input_service_description">
					<div class="input_service_description_line1">
						<img src="{% static 'images/101.png' %}" class="input_service_description_icon">
						<div class="input_service_description_text">æˆ‘æ˜¯ {{ website_name }} ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼</div>
					</div>
					
				</div>
				<form @submit.prevent="sendMessage">
					<div class="user_input_form">
						<div>
							<textarea x-model="inputMessage"
								 type="text"
								 placeholder='è¾“å…¥æ¶ˆæ¯...(æŒ‰"/"å¿«é€Ÿè¾“å…¥ æŒ‰enterå‘é€)'
								 class="user_input_textarea"
								 id="user_input_textarea"
								 @keydown.enter="userPressEnterInSendMessage(event)"
								 @keydown.window.slash=focusOnInput(event)></textarea>
						</div>
						<div>
							<img src="{% static 'images/settings.png' %}" class="settings_btn" @click="UserEnterSettings(event)">

						</div>
						<!-- <button type="submit" class="user_input_submit_btn">å‘é€</button> -->
					</div>
				</form>
				
			</div>
		</div>
		<div style="display: none;" x-show="show_settings" class="settings_background" @keydown.window.escape="CloseSettings()">
			<div class="settings_div" @click.away="CloseSettings()">
				<div style="color: red; font-size: 0.8rem;">
					æ³¨æ„ï¼Œåœ¨è¿™é‡Œä¿®æ”¹çš„ä¸œè¥¿åªæœ‰åœ¨å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨åæ‰ä¼šå†™å…¥æ•°æ®åº“ï¼Œåˆ‡æ¢å¯¹è¯ä¼šæ¶ˆå¤±ï¼Œè½½å…¥å¯¹è¯æ—¶ä¼šè‡ªåŠ¨è½½å…¥æ•°æ®åº“ä¸­å­˜å‚¨çš„è®¾ç½®
				</div>
				<div>
					<img src="{% static 'images/close.png' %}" class="settings_close_img" @click="CloseSettings()">
				</div>
				
				<div style="display: flex;" x-data = "{show_help : false, is_modify : false}">
					<div>
						<img src="{% static 'images/help.png' %}" class="params_help_img" @mouseenter="show_help = true" @mouseleave="show_help = false">
						<div x-show="show_help" class="params_help">é‡‡æ ·æ¸©åº¦ï¼Œä»‹äº 0 å’Œ 2 ä¹‹é—´ã€‚æ›´é«˜çš„å€¼ï¼Œå¦‚ 0.8ï¼Œä¼šä½¿è¾“å‡ºæ›´éšæœºï¼Œè€Œæ›´ä½çš„å€¼ï¼Œå¦‚ 0.2ï¼Œä¼šä½¿å…¶æ›´åŠ é›†ä¸­å’Œç¡®å®šã€‚ æˆ‘ä»¬é€šå¸¸å»ºè®®å¯ä»¥æ›´æ”¹è¿™ä¸ªå€¼æˆ–è€…æ›´æ”¹ top_pï¼Œä½†ä¸å»ºè®®åŒæ—¶å¯¹ä¸¤è€…è¿›è¡Œä¿®æ”¹ã€‚
						<p style="margin: 0px;"></p>
						æˆ‘ä»¬å»ºè®®æ‚¨æ ¹æ®å¦‚ä¸‹è¡¨æ ¼ï¼ŒæŒ‰ä½¿ç”¨åœºæ™¯è®¾ç½® temperatureã€‚
						<table><thead><tr><th>åœºæ™¯</th><th>æ¸©åº¦</th></tr></thead><tbody><tr><td>ä»£ç ç”Ÿæˆ/æ•°å­¦è§£é¢˜</td><td>0.0</td></tr><tr><td>æ•°æ®æŠ½å–/åˆ†æ</td><td>1.0</td></tr><tr><td>é€šç”¨å¯¹è¯</td><td>1.3</td></tr><tr><td>ç¿»è¯‘</td><td>1.3</td></tr><tr><td>åˆ›æ„ç±»å†™ä½œ/è¯—æ­Œåˆ›ä½œ</td><td>1.5</td></tr></tbody></table>
						</div>
					</div>
					<div>temperature</div>
					<input type="range" min="0" max="2" step="0.1" x-model="communication_temperature">
					<div x-show="!is_modify" x-text="Number(communication_temperature).toFixed(1)" @click="is_modify=true;focusByName('communication_temperature_input')" class="params_value"></div>
					
					<input name="communication_temperature_input" x-show="is_modify" @click.away="is_modify=false" type="text" x-model="communication_temperature" class="params_modify_input">
				</div>
				<div style="display: flex;" x-data = "{show_help : false, is_modify : false}">
					<div>
						<img src="{% static 'images/help.png' %}" class="params_help_img" @mouseenter="show_help = true" @mouseleave="show_help = false">
						<div x-show="show_help" class="params_help">
							top_p ä½œä¸ºè°ƒèŠ‚é‡‡æ ·æ¸©åº¦çš„æ›¿ä»£æ–¹æ¡ˆï¼Œæ¨¡å‹ä¼šè€ƒè™‘å‰ top_p æ¦‚ç‡çš„ token çš„ç»“æœã€‚æ‰€ä»¥ 0.1 å°±æ„å‘³ç€åªæœ‰åŒ…æ‹¬åœ¨æœ€é«˜ 10% æ¦‚ç‡ä¸­çš„ token ä¼šè¢«è€ƒè™‘ã€‚ æˆ‘ä»¬é€šå¸¸å»ºè®®ä¿®æ”¹è¿™ä¸ªå€¼æˆ–è€…æ›´æ”¹ temperatureï¼Œä½†ä¸å»ºè®®åŒæ—¶å¯¹ä¸¤è€…è¿›è¡Œä¿®æ”¹ã€‚
						</div>
					</div>
					<div>top_p</div>
					<input type="range" min="0" max="1" step="0.1" x-model="communication_top_p">
					<div x-show="!is_modify" x-text="Number(communication_top_p).toFixed(1)" @click="is_modify=true;focusByName('communication_top_p_input')" class="params_value"></div>
					
					<input name="communication_top_p_input" x-show="is_modify" @click.away="is_modify=false" type="text" x-model="communication_top_p" class="params_modify_input">
				</div>
				
				<div style="display: flex;" x-data = "{show_help : false, is_modify : false}">
					<div>
						<img src="{% static 'images/help.png' %}" class="params_help_img" @mouseenter="show_help = true" @mouseleave="show_help = false">
						<div x-show="show_help" class="params_help">
							ä»‹äº 1 åˆ° 8192 é—´çš„æ•´æ•°ï¼Œé™åˆ¶ä¸€æ¬¡è¯·æ±‚ä¸­æ¨¡å‹ç”Ÿæˆ completion çš„æœ€å¤§ token æ•°ã€‚è¾“å…¥ token å’Œè¾“å‡º token çš„æ€»é•¿åº¦å—æ¨¡å‹çš„ä¸Šä¸‹æ–‡é•¿åº¦çš„é™åˆ¶ã€‚
						</div>
					</div>
					<div>max_tokens</div>
					<input type="range" min="1" max="8192" step="1" x-model="communication_max_tokens">
					<div x-show="!is_modify" x-text="communication_max_tokens" @click="is_modify=true;focusByName('communication_max_tokens_input')" class="params_value"></div>
					
					<input name="communication_max_tokens_input" x-show="is_modify" @click.away="is_modify=false" type="text" x-model="communication_max_tokens" class="params_modify_input">
				</div>

				<div style="display: flex;" x-data = "{show_help : false, is_modify : false}">
					<div>
						<img src="{% static 'images/help.png' %}" class="params_help_img" @mouseenter="show_help = true" @mouseleave="show_help = false">
						<div x-show="show_help" class="params_help">ä»‹äº -2.0 å’Œ 2.0 ä¹‹é—´çš„æ•°å­—ã€‚å¦‚æœè¯¥å€¼ä¸ºæ­£ï¼Œé‚£ä¹ˆæ–° token ä¼šæ ¹æ®å…¶åœ¨å·²æœ‰æ–‡æœ¬ä¸­çš„å‡ºç°é¢‘ç‡å—åˆ°ç›¸åº”çš„æƒ©ç½šï¼Œé™ä½æ¨¡å‹é‡å¤ç›¸åŒå†…å®¹çš„å¯èƒ½æ€§ã€‚</div>
					</div>
					<div>frequency_penalty</div>
					<input type="range" min="-2" max="2" step="0.1" x-model="communication_frequency_penalty">
					<div x-show="!is_modify" x-text="Number(communication_frequency_penalty).toFixed(1)" @click="is_modify=true;focusByName('communication_frequency_penalty_input')" class="params_value"></div>
					
					<input name="communication_frequency_penalty_input" x-show="is_modify" @click.away="is_modify=false" type="text" x-model="communication_frequency_penalty" class="params_modify_input">
				</div>

				<div style="display: flex;" x-data = "{show_help : false, is_modify : false}">
					<div>
						<img src="{% static 'images/help.png' %}" class="params_help_img" @mouseenter="show_help = true" @mouseleave="show_help = false">
						<div x-show="show_help" class="params_help">ä»‹äº -2.0 å’Œ 2.0 ä¹‹é—´çš„æ•°å­—ã€‚å¦‚æœè¯¥å€¼ä¸ºæ­£ï¼Œé‚£ä¹ˆæ–° token ä¼šæ ¹æ®å…¶æ˜¯å¦å·²åœ¨å·²æœ‰æ–‡æœ¬ä¸­å‡ºç°å—åˆ°ç›¸åº”çš„æƒ©ç½šï¼Œä»è€Œå¢åŠ æ¨¡å‹è°ˆè®ºæ–°ä¸»é¢˜çš„å¯èƒ½æ€§ã€‚</div>
					</div>
					<div>presence_penalty</div>
					<input type="range" min="-2" max="2" step="0.1" x-model="communication_presence_penalty">
					<div x-show="!is_modify" x-text="Number(communication_presence_penalty).toFixed(1)" @click="is_modify=true;focusByName('communication_presence_penalty_input')" class="params_value"></div>
					
					<input name="communication_presence_penalty_input" x-show="is_modify" @click.away="is_modify=false" type="text" x-model="communication_presence_penalty" class="params_modify_input">
				</div>

				<div>
					<div style="margin-bottom: 10px;">ç³»ç»Ÿæç¤ºè¯ï¼š</div>
					<textarea class="system_content_textarea" x-model="system_content"></textarea>
				</div>
			</div>
		</div>
	</div>
	<!-- <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script> -->
	<script defer src="{% static 'js/alpinejs_min.js' %}"></script>
	<script src="{% static 'js/highlight.js' %}"></script>
	<script src="{% static 'js/axios_min.js' %}"></script>
	<script src="{% static 'js/my_marked.js' %}"></script>
	<script>
		urls = {}
		urls["login"] = "{% url 'mainsite:login' %}";
		urls["logout"] = "{% url 'mainsite:logout' %}";
		urls["talk"] = "{% url 'mainsite:talk' %}";
		urls["get_available_models"] = "{% url 'mainsite:get_available_models' %}";
		urls["get_history"] = "{% url 'mainsite:get_history' %}";
		urls["get_communication_content"] = "{% url 'mainsite:get_communication_content' %}";
		urls["delete_communication"] = "{% url 'mainsite:delete_communication' %}";
		urls["change_communication_title"] = "{% url 'mainsite:change_communication_title' %}";
		urls["copybtn_png"] = "{% static 'images/copybtn.png' %}";
		urls["check_png"] = "{% static 'images/check.png' %}";
		urls["get_params"] = "{% url 'mainsite:get_params' %}";
	</script>
	<script src="{% static 'js/mainsite.js' %}"> </script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
	<script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
</body>
</html>