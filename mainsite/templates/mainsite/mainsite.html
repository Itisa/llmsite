<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>DeepSeek Chat</title>
	{% load static %}
	<script src="{% static 'mainsite/tailwindcss.css' %}"></script>
	<link rel="stylesheet" href="{% static 'mainsite/highlight.css' %}">
	<script src="{% static 'mainsite/axios_min.js' %}"></script>
	<script src="{% static 'mainsite/highlight.js' %}"></script>
	<script src="{% static 'mainsite/marked.min.js' %}"></script>
	<script defer src="{% static 'mainsite/alpinejs_min.js' %}"></script>
	<style>
		pre {
/*			background-color: #eeeeee;*/
			padding: 1rem;
			border-radius: 4px;
			overflow-x: auto;
		}
		code {
			font-family: 'Courier New', Courier, monospace;
		}
	</style>
</head>
<body class="bg-gray-100">
	<div x-data="app()" class="min-h-screen">
		<!-- ç™»å½•æ¨¡å— -->
		<div x-show="!username" class="max-w-md mx-auto mt-20 p-6 bg-white rounded-lg shadow">
			<h2 class="text-2xl font-bold mb-4">ç”¨æˆ·ç™»å½•</h2>
			<form @submit.prevent="login">
				{% csrf_token %}
				<input x-model="loginForm.username"
					   type="text"
					   placeholder="ç”¨æˆ·å"
					   class="w-full mb-3 p-2 border rounded" name="username">
				<input x-model="loginForm.password"
					   type="password"
					   placeholder="å¯†ç "
					   class="w-full mb-3 p-2 border rounded" name="password">
				<button type="submit"
						class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
					ç™»å½•
				</button>
			</form>
			<div class="mt-4 text-center">
				<a href="{% url 'mainsite:register' %}" class="text-blue-500 hover:text-blue-700">æ³¨å†Œ</a>
			</div>
		</div>

		<!-- ä¸»ç•Œé¢ -->
		<div x-show="username" class="flex h-screen">
			<!-- ä¾§è¾¹æ  - å†å²è®°å½• -->
			<div class="w-64 bg-white border-r flex flex-col">
				<div class="p-4">
					<h3 class="text-lg font-semibold mb-4">å†å²å¯¹è¯</h3>
					<!-- æ–°å¢çš„ç”Ÿæˆæ–°å¯¹è¯æŒ‰é’® -->
					<button @click="createNewChat"
							class="w-full mt-4 p-2 bg-green-500 text-white rounded hover:bg-green-600">
						æ–°å»ºå¯¹è¯
					</button>
				</div>
				<!-- å†å²å¯¹è¯åˆ—è¡¨ï¼Œå•ç‹¬è®¾ç½®æ»šåŠ¨ -->
				<div class="flex-1 overflow-y-auto overflow-x-hidden p-4">
					<div class="space-y-2">
						<template x-for="item in titles.slice().reverse()" :key="item.id">
							<div @click="loadMessages(item.id)"
								 class="p-2 hover:bg-gray-100 cursor-pointer rounded flex justify-between items-start"
								 :class="{ 'bg-blue-50': item.id === cid }">
								<div>
									<div class="text-sm" x-text="item.title"></div>
									<div class="text-xs text-gray-500" x-text="item.date"></div>
								</div>
								<button @click.stop="deleteCommunication(item.id,item.title)" class="text-red-500 hover:text-red-700 text-sm ml-4">
									åˆ é™¤
								</button>
							</div>
						</template>
					</div>
				</div>
			</div>

			<!-- ä¸»èŠå¤©åŒºåŸŸ -->
			<div class="flex-1 flex flex-col">
				<!-- é¡¶éƒ¨æ¨ªæ¡ -->
				<div class="p-4 bg-gray-100 border-b">
					<div class="flex justify-between items-center mb-4">
						<div x-show = "!isEditingTitle" class="text-lg font-semibold" x-text="topBarContent"></div>
						<!-- ä¿®æ”¹æ ‡é¢˜æŒ‰é’® -->
						<button x-show="cid !== -1 && !isEditingTitle" @click="enableEditTitle" class="p-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
							ä¿®æ”¹æ ‡é¢˜
						</button>
					</div>
					<div x-show="isEditingTitle" class="p-4 bg-gray-50 border-b">
						<div class="flex space-x-2">
							<input x-model="newTitle"
								   type="text"
								   placeholder="è¾“å…¥æ–°æ ‡é¢˜"
								   class="flex-1 p-2 border rounded">
							<button @click="saveTitle" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
								ä¿å­˜
							</button>
							<button @click="cancelEditTitle" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
								å–æ¶ˆ
							</button>
						</div>
					</div>
				</div>
				<!-- æ¶ˆæ¯åŒºåŸŸ -->
				<div class="flex-1 overflow-y-auto p-4 space-y-4">
					<template x-for="message in messages" :key="message.id">
						<div :class="message.role === 'user' ? 'text-right' : 'text-left'">
							<div class="inline-block p-3 rounded-lg max-w-[70%] text-left"
								 :class="message.role === 'user'
									 ? 'bg-blue-500 text-white'
									 : 'bg-gray-200 text-gray-800'">
								<template x-if="message.role === 'user'">
									<div x-text="message.content"></div>
								</template>
								<template x-if="message.role === 'assistant'">
									<div x-html="marked.parse(message.content)"></div>
								</template>
								<div class="text-xs mt-1 opacity-70"
									 x-text="message.timestamp"></div>
							</div>
						</div>
					</template>
				</div>

				<!-- è¾“å…¥åŒºåŸŸ -->
				<div class="p-4 border-t bg-white">
					<form @submit.prevent="sendMessage">
						<div class="flex space-x-2">
							<textarea x-model="inputMessage"
								   type="text"
								   placeholder="è¾“å…¥æ¶ˆæ¯..."
								   class="flex-1 p-2 border rounded"
								   @keydown.enter="userPressEnter(event)"></textarea>
							<button type="submit"
									class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
								å‘é€
							</button>
						</div>
					</form>
					<!-- è¯­è¨€æ¨¡å‹é€‰æ‹©æ¡† -->
					<div class="mt-2">
						<select id="model-select" x-model="selectedModel" :disabled="cid !== -1" class="mt-1 block w-full p-2 border rounded">
							<template x-for="item in models">
								<option :value="item" x-text="item"></option>
							</template>
						</select>
					</div>
				</div>
			</div>
		</div>

		<!-- æ‚¬æµ®çƒ -->
		<div x-show="username" class="fixed">
			<div 
				x-show="show_floating_ball"
				x-ref="floating_ball"
				@click="floating_ball_toggleButtons"
				class="fixed left-10 bottom-10 w-16 h-16 bg-blue-500 rounded-full cursor-pointer flex items-center justify-center text-white text-2xl shadow-lg"
			>
				ğŸ¾
				<!-- æŒ‰é’®ç»„ -->
				<div x-show="floating_ball_showButtons" class="absolute bottom-20 left-1.5 space-y-2">
					<button class="w-12 h-12 bg-green-500 rounded-full text-white shadow-lg text-base" @click="logout">æ³¨é”€</button>
					<button class="w-12 h-12 bg-red-500 rounded-full text-white shadow-lg text-base flex flex-col items-center justify-center" @click="window.location.href = '{% url 'mainsite:change_password' %}'">
						<span class="leading-none">ä¿®æ”¹</span>
						<span class="leading-none">å¯†ç </span>
					</button>
					<button class="w-12 h-12 bg-yellow-500 rounded-full text-white shadow-lg text-base" @click="show_floating_ball=false">éšè—</button>
				</div>
			</div>

		</div>
	</div>
	<script>

	</script>
	<script defer>

		function deleteCookie(name, path, domain) {
			document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT;' +
				(path ? '; path=' + path : '') +
				(domain ? '; domain=' + domain : '');
		}
		function app() {
			return {
				// åº”ç”¨çŠ¶æ€
				user: null,
				loginForm: {
					csrfmiddlewaretoken: "",
					username: '',
					password: '',
				},
				messages: [],
				titles: [],
				models: [],
				inputMessage: '',
				username: null,
				topBarContent: null,
				cid: -1,
				isEditingTitle: false,
				newTitle: null,
				selectedModel: null,
				in_talk: false,
				marked,
				renderer: new marked.Renderer(),
				show_floating_ball: true,
				floating_ball_showButtons: false,
				init() {
					this.renderer.code = function (code, language) {
						// ä½¿ç”¨ highlight.js é«˜äº®ä»£ç 
						const validLanguage = hljs.getLanguage(code.lang) ? code.lang : 'plaintext';
						const highlightedCode = hljs.highlight(code.text, { language: validLanguage }).value;
						return `<pre><code class="hljs ${validLanguage}">${highlightedCode}</code></pre>`;
					};
					marked.setOptions({
						renderer: this.renderer,
					});
					console.log("init");
					this.topBarContent = "æ–°å¯¹è¯";
					for (let i = 0; i < this.titles.length; ++i){
						this.titles[i].date = new Date(this.titles[i].date).toLocaleString();
					}
					if (document.cookie) {
						const cookiePairs = document.cookie.split('; ');
						cookiePairs.forEach(pair => {
							const [key, value] = pair.split('=');
							if (key=="username"){
								this.username = decodeURIComponent(value);
							}
						});
					}
					if (this.username){
						this.loadHistory();
						this.loadModels();
					}
				},

				// ç™»å½•æ–¹æ³•
				login() {
					this.loginForm.csrfmiddlewaretoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
					axios.post(
							"{% url 'mainsite:login' %}",
							new URLSearchParams(this.loginForm).toString(),
						)
						.then(response => {
							console.log(response)
							window.location.href = "{% url 'mainsite:site' %}";
						})
						.catch(error => {
							console.error('ç™»å½•å¤±è´¥:', error);
						});
				},
				logout() {
					deleteCookie("username","/");
					deleteCookie("sessionid","/");
					setTimeout(function() {window.location.href = "{% url 'mainsite:site' %}";}, 10);
				},
				userPressEnter(event){
					if (event.shiftKey) {
						return ;
					} else {
						event.preventDefault();
						this.sendMessage();
					}

				},
				// å‘é€æ¶ˆæ¯
				sendMessage() {
					if (!this.inputMessage.trim()) return ;
					if (this.in_talk) return ;
					this.cancelEditTitle();
					const uploadMessage = this.inputMessage;
					this.inputMessage = "";

					this.messages.push({
						id: Date.now(),
						content: uploadMessage,
						role: 'user',
						timestamp: new Date().toLocaleTimeString()
					});

					fetch("{% url 'mainsite:talk' %}", {
						method: 'POST',	
					
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						},
						body: JSON.stringify({
							model_name: this.selectedModel,
							message: uploadMessage,
							timestamp: Date.now(),
							cid: this.cid,
						})
					})
					.then(response => {
						this.in_talk = true;
						console.log(response)
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						this.messages.push({
							id: Date.now(),
							content: "",
							role: 'assistant',
							timestamp: new Date().toLocaleTimeString(),
						});
						const reader = response.body.getReader();
						const decoder = new TextDecoder();

						var firstchunk = true;
						const readChunk = () => {
							reader.read().then(({ done, value }) => {
								if (done) {
									console.log('Stream complete');
									this.in_talk = false;
									return;
								}
		
								const chunk = decoder.decode(value);
								// å‡è®¾æœåŠ¡å™¨è¿”å›çš„æ˜¯é€è¡Œ JSON æ•°æ®
								chunk.split('\n').forEach(line => {
									if (line.trim()) {

									try {
										const jsonData = JSON.parse(line);
										if (firstchunk){
											if (this.cid == -1){ // æ–°å¯¹è¯
												this.titles.push({
													id: jsonData.cid,
													title: jsonData.title,
													date: Date.now(),
												});
												this.cid = jsonData.cid;
												this.update_topBar();
											}
											firstchunk = false;
										}
										this.messages[this.messages.length-1].content += jsonData.message;
									} catch (error) {
										console.error('Error parsing JSON:', error);
									}

									}
								});
								readChunk();  // ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®å—
							});
						};
						readChunk();
					})
					.catch(error => {
						console.error('Error fetching stream:', error);
					});
				},
				// åŠ è½½å¯é€‰æ¨¡å‹
				loadModels() {
					axios.get("{% url 'mainsite:other_functions' %}", {
						params:{
							cmd: "load models",
						}
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						this.models = response.data.data;
						this.selectedModel = this.models[0];
					})
					.catch(error => {
						console.error('loadModelsè¯·æ±‚å¤±è´¥:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},
				// åŠ è½½å†å²è®°å½•
				loadHistory() {
					console.log("loadHis");
					axios.get("{% url 'mainsite:talk' %}", {
						params:{
							cid: -1,
						}
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						this.titles = response.data.titles
						for (var i = 0; i < this.titles.length; i++) {
							this.titles[i].date = new Date(this.titles[i].date).toLocaleString();
							this.titles[i].title = this.titles[i].title;
						}
					})
					.catch(error => {
						console.error('loadHistoryè¯·æ±‚å¤±è´¥:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},

				// åŠ è½½å¯¹è¯æ¶ˆæ¯
				loadMessages(cid){
					if (this.in_talk) return ;
					console.log("cid",cid);
					axios.get("{% url 'mainsite:talk' %}", {
						params:{
							cid: cid,
						}
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						this.messages = response.data.messages
						for (var i = 0; i < this.messages.length; i++) {
							this.messages[i].timestamp =new Date(this.messages[i].timestamp).toLocaleString();
						}
						this.cid = cid;
						this.update_topBar();
					})
					.catch(error => {
						console.error('loadMessagesè¯·æ±‚å¤±è´¥:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},

				// æ›´æ–°å½“å‰å¯¹è¯æ ‡é¢˜
				update_topBar() {
					for (let i = 0; i < this.titles.length; i++) {
						if (this.cid == this.titles[i].id){
							this.topBarContent = this.titles[i].title;
							break;
						}
					}
				},

				deleteCommunication(cid,title) {
					let yes = confirm(`ç¡®è®¤åˆ é™¤  ${title} ï¼Ÿ åˆ é™¤åå°†ä¸å¯æ¢å¤`)
					if (!yes) return ;
					axios.post("{% url 'mainsite:other_functions' %}", {
						cmd: "delete communication",
						cid: cid,
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						for (var i = 0; i < this.titles.length; i++) {
							if (cid == this.titles[i].id){
								if (cid == this.cid) {
									this.createNewChat();
								}
								this.titles.splice(i,1);
								break;
							}
						}
					})
					.catch(error => {
						console.error('deleteCommunicationè¯·æ±‚å¤±è´¥:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},

				// å¼€å¯æ–°å¯¹è¯
				createNewChat() {
					if (this.in_talk) return ;
					this.cid = -1;
					this.topBarContent = "æ–°å¯¹è¯";
					this.messages = [];
				},
				// å¼€å¯/å…³é—­æ ‡é¢˜ç¼–è¾‘
				enableEditTitle(){
					if (this.in_talk) return ;
					this.isEditingTitle = true;
					this.newTitle = this.topBarContent;
				},
				cancelEditTitle(){
					if (this.in_talk) return ;
					this.isEditingTitle = false;
					this.newTitle = null;
				},

				// ä¿å­˜æ–°æ ‡é¢˜
				saveTitle(){
					if (this.in_talk) return ;
					console.log("saveTitle",this.newTitle);
					axios.post("{% url 'mainsite:other_functions' %}", {
						cmd: "change communication title",
						cid: this.cid,
						newtitle: this.newTitle,
					}, {
						headers: {
							"Content-Type": "application/json",
							'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						}
					})
					.then(response => {
						console.log(response)
						for (let i = 0; i < this.titles.length; i++) {
							if (this.cid == this.titles[i].id){
								this.titles[i].title = this.newTitle;
								this.topBarContent = this.titles[i].title;
								break;
							}
						}
						this.cancelEditTitle();
					})
					.catch(error => {
						console.error('saveTitleè¯·æ±‚å¤±è´¥:', error);
						if (error.response.data.message == "sessionid expires"){
							this.logout();
						}
					});
				},
				floating_ball_toggleButtons() {
					if (!this.floating_ball_dragging) {
						this.floating_ball_showButtons = !this.floating_ball_showButtons;
					}
				},
			}
		}
		
	</script>
</body>
</html>